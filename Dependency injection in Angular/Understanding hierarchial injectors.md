Механизм DI в Angular.
DI - паттерн проектировани, который позволяет использовать зависимости из внешних ресурсов(классов) не создавая при этом их экземпляры. В Angular создание необходимого экземпляра класса отводится встроенному сервису Injector. Этот сервис создает экземпляр необходимого класса и возвращает его. Т.к в большинстве случает необходим синглтон Injector создает данный экземпляр единожды и возвращает его во все необходимые конструкторы.![[Pasted image 20230424125135.png]]

Пример механизма DI.

Напишем примеры сервиса и компонета, который использует зависимости данного сервиса.
![[Pasted image 20230424130723.png]]
Теперь рассмотрим механизм, который создает экземпляры классов и позволяет использовать их методы.
![[Pasted image 20230424130928.png]]
13 строка - создаение приватного поля контейнер, который будет содержать экзепляры всех необходимых классов

15 строка - в конструкто передаем аргумент providers, который по сути своей является массивом всех сервисов, которые мы регистрируем в модуле в свойстве providers:[] или при помощи св-ва providedIn декоратора Injectable

16 строка - проходим по данному массиву и создаем экземпляры всех сервисов, которые были зарегистрированы

19 строка - создаем метод, который будет получить необходимый инстанс и возвращать его, в случае же попытки получить сервис, который не был зарегистрирован, выбрасывается ошибка.
![[Pasted image 20230424132647.png]]
Теперь, когда мы запускаем приложение происходит следующее:

30 строка - создается экземпляр инжектора, в который передаются все зарегистрированные сервисы

31 строка - создается экземпляр компонента, в который передается необходимый сервис, который был создан инжектором. После чего мы можем использовать метод стороннего класса(сервиса).

Иерархия инжекторов.

В Angular не один инжекторы и необходимо как то отслеживать из какого же инжектора отдавать зависимость запрошивающему компоненту.

Существует две последовательности инжекторов, в которых ищется регистрация необходимого сервиса: Модульные инжекторы и инжекторы элементов.

Модульные инжекторы

![[Pasted image 20230424135138.png]]
в случае если мы не используем LazyLoadedModule, то иерархия модулей будет выглядеть следующим образом - в самом низу Root injector - в данном инжекторе создаются экземпляры всех сервисов, которые были зарегистрированные в модулях или при помощи декоратора Injectable. При регистрации в различных модулях не создаются экземпляры сервисов для каждого модуля, а передается все в рутовый инжектор.

Если же существуют лейзи модули - для подобных модулей создаются Child Injector![[Pasted image 20230424140015.png]]

Элементные инжекторы

Данные инжекторы создаются для любого компонента или директивы, у которых есть свойство providers![[Pasted image 20230424140154.png]]

В отличае от модульных инжекторов в элементном чайлд инжекторы создаются для каждого чайлд компонента, а это означает, что если есть Parent и Child компонент и для каждого из них указать providers, то для каждого компонента создастся отдельный инжектор со своим экземпляром.
![[Pasted image 20230424144236.png]]

При разрешении зависимостей поиск необходимого токена для инжекта зависимости происходит следующий проход по инжекторам: ![[Pasted image 20230424144820.png]]
сначала проверяется самый низкий уровень инжектора на наличие токена, затем поднимается наверх по элементным инжекторам. В случае не нахождения - поиск переходит на рутовый модульный инжектор и двигается вверх до NullInjector, который выкидывает ошибку в случае не нахождения