Initial & feature state

Для использования библиотеки NgRx необходимо создать state. State - это текущее состояние данных. Общий state приложения может состоять из нескольких feature state. Создадим state для task feature.
![[Pasted image 20230425154352.png]]
создаем интрефейс TaskState и объект initialState, реализующий данный интерфейс.
Теперь создадим AppState
![[Pasted image 20230425154812.png]]
импортируем все стейты, которые необходимы в общем, создаем ключи под каждый из них и создаем интерфейс AppState
Таким образом мы описали структуру, в которой будет храниться все данные.

Action

Экшн - это объект с обязательным свойством type, которое по сути является названием данного экшена

![[Pasted image 20230425155346.png]]
помимо данного обязательнго св-ва могут быть и не обязательные
![[Pasted image 20230425155634.png]]
для создания файла с экшенами воспользуемся соответсвующей командой CLI. Для создания экшена использоуются функция createAction, в которую передается тип данного экшена, и props, если есть какие то данные, которые неоходимо пердать через этот экшн.

Reducer

Reducer - это исполнитель данных экшенов, он прослушивает все экшены и реагирует на необходимые. После чего возвращает новое состояние.![[Pasted image 20230425162141.png]]
Создается при помощи функции createReducer, передается initialState и добавляются функции on, которые реагируют на экшены определенного типа. Колбек функции on - это и есть реакция на определенный экшен. Данный колбек в примере просто возвращает текущий стейт

Подключение стора

После написания базовых структур необходимо подключить стор. Как и многое другое в Ангулар, подключение нстора происходит с помощью модуля![[Pasted image 20230427102928.png]]
Создается StoreModule, в импортах которого используется метод forRoot. Первым аргументом в данном методе передается либо пустой объект, либо мап-объект,где ключ - 
то название стейта, а значение - редюсер, который за него отвечает.![[Pasted image 20230427105040.png]]
Если же мы хотим разбить стор на разные стейты, тогда данный объект остается пустым, и создается отдельный модуль и вызывается метод forFeature, в котором передается такой же мап-объект

Чтение из стора

Для чтения из стора необходимо как в сервисах - внедрить зависимость на данный стор и выбрать из него стейт, который нам необходим. Делается это следующим образом: ![[Pasted image 20230427111218.png]]

С помощью метода select мы подписываемся на стор и передаем в него название того featureKeyState, стейт которого нам необходимо получить, в данном случае это таск. Таким образом мы получаем весь объект стейта, который выглядит следующим образом:![[Pasted image 20230427111609.png]]
т.к необходимые задачи находятся в свойстве data получаем данное свойство в теплейте

Отправка(диспатч) экшенов.

Для того, чтобы совершить какое либой действие со стейтом, необходимо отправить экшен, который будет получен редюсером и уже он изменит стейт необходимым образом. Рассмотрим на примере![[Pasted image 20230427112938.png]]
в нужном компоненте отправляем экшен путем вызова метода dispatch у store, в аргументах передаем название необходимого экшена. Если данных экшен содержит в себе какие либо данные, то их так же необходимо передать в агрументах. Теперь настраиваем редюсер, который отвечает за данный стейт.![[Pasted image 20230427113148.png]]
в этом примере мы прослушиваем экшн completeTask, строим новый массив data, в котором у нужной задачи изменяем поле done на true. По завершению формирования массива возвращаем новый стейт с уже измененным полем data.

Effects

Эффекты - это способо комуникации стора с бекендом. Т.к редюсер должен быть чистой функцией, т.к не иметь никаких сайд эффектов, был добавлен еще один шаг, который позволяет соблюсти это правило.![[Pasted image 20230427115028.png]]
Создание эффекта![[Pasted image 20230427115134.png]]

Создаем отдельный файл со всеми эффектами, которые относятся к определенному стейту![[Pasted image 20230427125524.png]]
в данному случает создается эффект getTasks, который вернет все таски. Делается это при помощи функции createEffect, в которой есть оператор ofType. Данный оператор отслеживает какой то конкретный экшен на подобии оператора on в редюсере. В данном примере после получения соответствующего экшена идет запрос при помощи сервиса, дале в then мы получаем данные и генерируем новый экшен, в который и передаем данный результат. В случае ошибки так же генерируем экшен, но передаем уже ошибку.

Провайд экшена

Включение экшена в систему происходит аналогичным образом![[Pasted image 20230427130653.png]]
в фича стор модуле вызывается метод forFeature и передается массив всех эффектов, которые неоходимо добавить![[Pasted image 20230427130821.png]]
затем в рут стор модуле вызывается метод forRoot модуля EffectsModule